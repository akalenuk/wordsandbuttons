<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=0.84">
	<title>Linear transformations</title>
	<meta name="description" content="">
	<meta name="keywords" content="mathematics, tutorials">
	<link rel="shortcut icon" type="image/x-icon" href="favicon.svg" />
	<style>
body {
	margin: 0 0 0 0;
}

a {
	text-decoration: none;
}

h1 {
	padding-top: 36pt;
	font-size: 24pt;
	width: 600pt;
	text-align: left;
}

h2 {
	padding-top: 20pt;
	font-size: 20pt;
	width: 555pt;
	text-align: left;
}

p {
	line-height: 1.42;
	font-size: 16pt;
	width: 505pt;
	text-align: left;
}

.formula {
	font-family: sans-serif;
	font-size: 16pt;
	font-style: italic;
	padding-top: 6pt;
	padding-bottom: 6pt;
}

.comment {
	font-size: 12pt;
	text-align:center;
	font-family: sans-serif;
	padding-bottom: 24pt;
}

input[type="text"] {
	height: 16pt;
	width: 430pt;
	font-size: 16pt;
}

button{
	width: 108pt;
	font-size: 14pt;
}

canvas { touch-action: none; }
	</style>
	<script language="JavaScript">
// client
var w = 640.0;
var h = 640.0;

// colors
var colors = ["#d64562", "#457fd6", "#339428"];

// visible region for dot
var x_min = -3;
var y_min = -3;
var x_max = 3;
var y_max = 3;

var client_x_center = w*(0-x_min)/(x_max-x_min) - 0.5;
var client_x_step = (w/(x_max-x_min));

var client_y_center = h - h*(0-y_min)/(y_max-y_min) - 0.5;
var client_y_step = (h/(y_max-y_min));


function client_to_x(client_x){
	return (client_x - client_x_center) / client_x_step;
}

function client_to_y(client_y){
	return (client_y_center - client_y) / client_y_step;
}

function x_to_client(x){
	return x * client_x_step + client_x_center;
}

function y_to_client(y){
	return client_y_center - y * client_y_step;
}

function draw_grid_on(context, scale_exception){
	// grid
	context.beginPath();
	if(!scale_exception) {
		context.moveTo(0, client_y_center);
		context.lineTo(w, client_y_center);
	} else {
		context.moveTo(w, client_y_center);
	}
	context.lineTo(w - 12, client_y_center - 5);
	context.moveTo(w, client_y_center);
	context.lineTo(w - 12, client_y_center + 5);
	context.moveTo(client_x_center, h);
	context.lineTo(client_x_center, 0);
	context.lineTo(client_x_center - 5, 12);
	context.moveTo(client_x_center, 0);
	context.lineTo(client_x_center + 5, 12);
	context.fillStyle="#000000";
	for(var i = x_min + 1; i <= x_max - 1; i++){
		if(i != 0) {
			context.moveTo(client_x_center + i*client_x_step, client_y_center);
			context.lineTo(client_x_center + i*client_x_step, client_y_center - 5);
			context.fillText(i, client_x_center + i*client_x_step + 4, client_y_center + 16);
		}
	}
	for(var i = y_min + 1; i <= y_max - 1; i++){
		if(i != 0) {
			context.moveTo(client_x_center, client_y_center - i*client_y_step);
			context.lineTo(client_x_center + 5, client_y_center - i*client_y_step);
		}
		context.fillText(i, client_x_center + 5, client_y_center - i*client_y_step + 16);
	}
	context.fillText('i', client_x_center + 7, 23);
	context.strokeStyle = "#000000";
	context.stroke();
	context.closePath();
}

function draw_arrow(context, x1, y1, x2, y2, color) {
	var d = Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2));
	context.beginPath();
	context.moveTo(x1, y1);
	context.lineTo(x2, y2);
	context.moveTo(x2 - (y2 - y1) * 6 / d - (x2 - x1) * 16 / d, y2 - (y2 - y1) * 16 / d + (x2 - x1) * 6 / d);
	context.lineTo(x2, y2);
	context.moveTo(x2 + (y2 - y1) * 6 / d - (x2 - x1) * 16 / d, y2 - (y2 - y1) * 16 / d - (x2 - x1) * 6 / d);
	context.lineTo(x2, y2);
	context.strokeStyle = color;
	context.stroke();
	context.closePath();
}


function sharp(x) {
	return Math.floor(x + 0.5) - 0.5;
}

// conformal
var formula = 'x';
var t = 0;
var st = 0;
function draw_conformal(client_x, client_y, do_guides){
	var conformal = document.getElementById("conformal");
	var context = conformal.getContext("2d");
	context.font = "16px sans-serif";
	// background
	context.fillStyle="#eeeeee";
	context.fillRect(0, 0, w, h);

	const f = formula;
	context.beginPath();
	const grid_n = 4;
	for(var i = -1; i <= 1; i+=1/grid_n) {
		for(var j = -1; j <= 1; j+=1/grid_n) {
			if(i < 1.) {
				context.moveTo(sharp(x_to_client(j)), sharp(y_to_client(i)));
				context.lineTo(sharp(x_to_client(j)), sharp(y_to_client(i + 1/grid_n)));
			}
			if(j < 1.) {
				context.moveTo(sharp(x_to_client(j)), sharp(y_to_client(i)));
				context.lineTo(sharp(x_to_client(j + 1/grid_n)), sharp(y_to_client(i)));
			}
		}
	}
	context.strokeStyle = "#bbb";
	context.stroke();
	context.closePath();

	context.beginPath();
	const grid_detail = 4.;
	for(var i = -1; i <= 1; i+=1/grid_n) {
		for(var j = -1; j <= 1; j+=1/grid_n) {
			const transformed = calc(f, [j, i]);
			if(i < 1.) {
				for(var k = 0; k <= grid_detail; ++k) {
					const transformed = calc(f, [j, i + 1/grid_n * (k / grid_detail)]);
					if(k == 0)
						context.moveTo(x_to_client(transformed[0]), y_to_client(transformed[1]));
					else
						context.lineTo(x_to_client(transformed[0]), y_to_client(transformed[1]));
				}
			}
			if(j < 1.) {
				for(var k = 0; k <= grid_detail; ++k) {
					const transformed = calc(f, [j + 1/grid_n * (k / grid_detail), i]);
					if(k == 0)
						context.moveTo(x_to_client(transformed[0]), y_to_client(transformed[1]));
					else
						context.lineTo(x_to_client(transformed[0]), y_to_client(transformed[1]));
				}
			}
		}
	}
	context.strokeStyle = colors[0];
	context.stroke();
	context.closePath();

	// grid
	draw_grid_on(context, false);
}


// simple interpreter
// it only works on numbers for testing, todo: switch to complexs
function number_or_x(n, x) {
	const n_trim = n.trim();
	if(n_trim == 't') {
		return [st, 0];
	} else if(n_trim == 'ti') {
		return [0, st];
	} else if(n_trim == 'x') {
		return x;
	} else if(n_trim == '') {
		return [0., 0.];
	} else if(n.indexOf('i') != -1) {
		const x_i = n.split('i');
		return [0., Number(x_i[0])];
	} else if(n.indexOf(',') != -1) {
		const x_i = n.replace('_', '-').replace('_', '-').split(',');	// hack to avoid - as a binary operation
		return [Number(x_i[0]), Number(x_i[1])];
	} else {
		return [Number(n), 0.];
	}
}

function add(a, b) {
	return [a[0]+b[0], a[1]+b[1]];
}

function sub(a, b) {
	return [a[0]-b[0], a[1]-b[1]]
}

function mul(a, b) {
	return [a[0]*b[0] - a[1]*b[1], a[0]*b[1] + a[1]*b[0]];
}

function div(a, b) {
	const conj = [b[0], -b[1]];
	const divisor = mul(conj, conj)[0];
	return mul(mul(a, conj), [1./divisor, 0.]);
}

function pow(a, b) {
	var c = [1, 0];
	for(var i = 0; i < Math.floor(b[0]); ++i)
		c = mul(c, a);
	return c;
}

function pows(expr, x) {
	const exprs = expr.split('^');
	if(exprs.length == 1)
		return number_or_x(expr, x);
	else {
		const ys = exprs.map(function(n) { return number_or_x(n, x);});
		return ys.reduce(function(a, v) {return pow(a, v);})
	}
}

function divs(expr, x) {
	const exprs = expr.split('/');
	if(exprs.length == 1)
		return pows(expr, x);
	else {
		const ys = exprs.map(function(n) {return pows(n, x);});
		return ys.reduce(function(a, v) {return div(a, v);})
	}
}

function muls(expr, x) {
	const exprs = expr.split('*');
	if(exprs.length == 1)
		return divs(expr, x);
	else {
		const ys = exprs.map(function(n) {return divs(n, x);});
		return ys.reduce(function(a, v) {return mul(a, v);})
	}
}

function subs(expr, x) {
	var exprs = expr.split('-');
	if(exprs.length == 1)
		return muls(expr, x);
	else {
		if(exprs[0] == '') 
			exprs[0] = '0';
		const ys = exprs.map(function(n) {return muls(n, x);});
		return ys.reduce(function(a, v) {return sub(a, v);})
	}
}

function adds(expr, x) {
	const exprs = expr.split('+');
	if(exprs.length == 1)
		return subs(expr, x);
	else {
		const ys = exprs.map(function(n) {return subs(n, x);});
		return ys.reduce(function(a, v) {return add(a, v);})
	}
}

function find_correspondent_bracket(line, start_at) {
	var nestedness = 1;
	for(var i = start_at; i < line.length; ++i) {
		if(line[i] == '(')
			nestedness += 1;
		else if(line[i] == ')')
			nestedness -= 1;
		if(nestedness == 0)
			return i;
	}
	return -1;
}

function calc(expr, x) {
	if(expr.lastIndexOf(')') == -1 && expr.indexOf('(') == -1) {
		// compute with no brackets
		return adds(expr, x);
	} else {
		if(expr.indexOf('(') == -1 || expr.lastIndexOf(')') < expr.indexOf('(')) {
			// todo: report error
			return 'error';
		} else {
			const opens_at = expr.indexOf('(')
			const closes_at = find_correspondent_bracket(expr, opens_at + 1);

			const prefix = expr.substring(0, opens_at);
			const sub_expr = expr.substring(opens_at + 1, closes_at);
			const suffix = expr.substring(closes_at + 1);

			const mid_part = String(calc(sub_expr, x)).replace('-', '_').replace('-', '_'); // to avoid - as operation
			return calc(prefix + mid_part + suffix, x);
		}
	}
}

function reset_formula() {
	formula = document.getElementById("transforamtion").value;
}

function make_link() {
	const link = 'https://wordsandbuttons.online/complex_numbers_and_conformal_mapping.html?f=' + formula + '#plot';
	const no_spaces = link.replaceAll(' ', '');
	document.getElementById("plot_url").innerHTML = 'Your link to share: <a href="'+no_spaces+'">'+no_spaces+'</a>';
}
	</script>
</head>
<body>
	<center>
	<h1>
Linear transformations
	</h1>

	<span id="plot"></span>
	<table style="width:505pt"><tr><td>
		<input type="text" id="transforamtion" value="ti/2*x^2 - 2*(x - 0.2i)" oninput="document.getElementById('button_1').disabled = false;" onchange="reset_formula();make_link();">
	</td><td>
		<button type="button" onclick="reset_formula();make_link();" id="button_1" disabled><nobr>&darr; reload</nobr></button>
	</td></tr></table>
	<br />
	<canvas id="conformal" width=640 height=640></canvas>
	<p class="comment" id="plot_url"></p>
	<script language="JavaScript"> // init
// read formula if any
const href_and_vars = window.location.href.split('?');
if(href_and_vars.length == 2) {
	if(href_and_vars[1].length > 2 && href_and_vars[1][0] == 'f' && href_and_vars[1][1] == '=')
		document.getElementById("transforamtion").value = href_and_vars[1].split('=')[1].split('#')[0];
}

reset_formula();
function redraw() {
	draw_conformal();
	const lag = 1000/24;
	setTimeout(redraw, lag);
	t += 1 / lag;
	st = Math.sin(t);
}
redraw();
	</script>

	<script language="JavaScript"> // tests

	</script>

	<table class="footer" style="width: 555pt; padding: 64pt 0pt 32pt 0pt; background-color: transparent; font-family: sans-serif; font-size: 16pt; font-style: normal;">
	<tr>
	<td class="footer" style="vertical-align: middle; text-align: left; width: 64px; padding: 0; margin: 0; border: 0;">
		<a href="index.html">Index</a>
		<a href="all_mathematics.html">#mathematics</a> <a href="all_tutorials.html">#tutorials</a>
	</td>
	<td class="footer" style="vertical-align: middle; text-align: left; width: 200pt; padding: 0; margin: 0; border: 0;">
		&nbsp;&larr; there's more.
	</td>
	<td class="footer" style="vertical-align: middle; text-align: right; width: 300pt; padding: 0; margin: 0; border: 0;">
		+
		<a href="https://github.com/akalenuk/wordsandbuttons">Github</a> &
		<a href="https://twitter.com/wordsandbuttons">Twitter</a> &
		<a href="https://wordsandbuttons.online/rss"><span style="letter-spacing: 1pt;">RSS</span></a>
	</td>
	</tr>
	</table>
	</center>
</body>
</html>
