<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=0.84">
	<title>Challenge your performance intuition with C++ sine</title>
	<meta name="description" content="One more interactive quiz. This time, it's all about the sine function. Which one is faster and when?">
	<meta name="keywords" content="programming, quizzes">
	<link rel="shortcut icon" type="image/x-icon" href="favicon.svg" />
	<style>
body{
	margin: 0 0 0 0;
}

a{
	text-decoration: none;
}

h1 {
	padding-top: 36pt;
	font-size: 24pt;
	width: 600pt;
	text-align: left;
}

h2 {
	padding-top: 64pt;
	font-size: 20pt;
	width: 555pt;
	text-align: left;
}

p {
	line-height: 1.42;
	font-size: 16pt;
	width: 505pt;
	text-align: left;
}

.comment {
	font-size: 14pt;
	text-align:center;
	font-family: sans-serif;
	padding-bottom: 24pt;
}

table.footer {
	padding: 64pt 0pt 32pt 0pt;
	background-color: transparent;
	width: 505pt;
}

td.footer {
	font-family: sans-serif;
	font-size: 16pt;
	font-style: normal;
	padding: 0;
	margin: 0;
	border: 0;
}

pre {
	margin: 0 0 0 0;
	padding-top: 12pt;
	padding-left: 12pt;
	padding-right: 12pt;
	padding-bottom: 12pt;
	font-size: 12pt;
	text-align: left;
	width: 360pt;
}

table {
	text-align: center;
	border-width: 0pt;
}

td {
	padding: 6pt 12pt 6pt 12pt;
	font-size: 16pt;
	border: 1px solid black;
}

button{
	width: 304pt;
	height: 42pt;
	margin-left:4pt;
	margin-right:4pt;
	font-size: 18pt;
}


canvas { touch-action: none; }
	</style>
	<script language="JavaScript">
var slider_set = [false, false, false, false,  false, false, false, false,  false, false];
var slider_true_xs = [
	0.0723318 / (0.0723318 + 0.0098595) * 512,
	0.0754377 / (0.0754377 + 0.0296685) * 512,
	0.072668 / (0.072668 + 0.0453003) * 512,
	0.0457249 / (0.0457249 + 0.083724) * 512,

	0.0723615 / (0.0723615 + 0.0194681) * 512,
	0.0191127 / (0.0191127 + 0.0634028) * 512,
	0.0340617 / (0.0340617 + 0.0351423) * 512
	];
var slider_user_xs = [256, 256, 256, 256,  256, 256, 256];
var slider_xs = [256, 256, 256, 256,  256, 256, 256];

var slider_down = false;

function comment_on_slider(no){
	var left = document.getElementById("left_" + (no + 1));
	var right = document.getElementById("right_" + (no + 1));
	var x = slider_xs[no]
	var xl = x;
	var xr = 511 - x;
	if(x < 255){
		left.style.backgroundColor = "#" + (Math.round(xl)).toString(16) + "ff" + (Math.round(xl)).toString(16);
		right.style.backgroundColor = "#ff" + (Math.round(xl)).toString(16) + (Math.round(xl)).toString(16);
	}else{
		right.style.backgroundColor = "#" + (Math.round(xr)).toString(16) + "ff" + (Math.round(xr)).toString(16);
		left.style.backgroundColor = "#ff" + (Math.round(xr)).toString(16) + (Math.round(xr)).toString(16);
	}

	var comment = document.getElementById("comment_" + (no + 1));
	if(Math.abs(xl - xr) < 3){
		comment.innerHTML = "They are almost the same.";
	}else if(xl > xr){
		if(xl > 20*xr){
			comment.innerHTML = "Right is more than 20 times faster!";
		}else if(xl > 10*xr){
			comment.innerHTML = "Right is more than 10 times faster!";
		}else if(xl > 5*xr){
			comment.innerHTML = "Right is more than 5 times faster!";
		}else if(xl > 3*xr){
			comment.innerHTML = "Right is more than 3 times faster!";
		}else if(xl > 2*xr){
			comment.innerHTML = "Right is more than 2 times faster!";
		}else if(xl > 1.5*xr){
			comment.innerHTML = "Right is more than 50% faster.";
		}else if(xl > 1.25*xr){
			comment.innerHTML = "Right is more than 25% faster.";
		}else if(xl > 1.1*xr){
			comment.innerHTML = "Right is more than 10% faster.";
		}else{
			comment.innerHTML = "Right is slightly faster.";
		}
	}else if(xr > xl){
		if(xr > 20*xl){
			comment.innerHTML = "Left is more than 20 times faster!";
		}else if(xr > 10*xl){
			comment.innerHTML = "Left is more than 10 times faster!";
		}else if(xr > 5*xl){
			comment.innerHTML = "Left is more than 5 times faster!";
		}else if(xr > 3*xl){
			comment.innerHTML = "Left is more than 3 times faster!";
		}else if(xr > 2*xl){
			comment.innerHTML = "Left is more than 2 times faster!";
		}else if(xr > 1.5*xl){
			comment.innerHTML = "Left is more than 50% faster.";
		}else if(xr > 1.25*xl){
			comment.innerHTML = "Left is more than 25% faster.";
		}else if(xr > 1.1*xl){
			comment.innerHTML = "Left is more than 10% faster.";
		}else{
			comment.innerHTML = "Left is slightly faster.";
		}
	}
}

function position_slider(no, client_x){
	if(!slider_set[no]){
		var slider = document.getElementById("slider_" + (no + 1));
		var canvas_rect = slider.getBoundingClientRect();
		var x = client_x - canvas_rect.left - 48;
		if(x < 16)
			x = 16;
		if(x > 511 - 16)
			x = 511 - 16;
		slider_xs[no] = x;

		comment_on_slider(no);
	}
}

function init_slider(no){
	draw_slider(no);
	var slider = document.getElementById("slider_" + (no + 1));

	slider.addEventListener('pointerleave', function(e){
		slider_down = false;
	}, false);

	slider.addEventListener('pointerup', function(e){
		slider_down = false;
	}, false);

	slider.addEventListener('pointerdown', function(e){
		slider_down = true;
		position_slider(no, e.clientX);
		draw_slider(no);
		slider.releasePointerCapture(e.pointerId);
	}, false);

	slider.addEventListener('pointermove', function(e){
		if(slider_down){
			position_slider(no, e.clientX);
			draw_slider(no);
		}
	}, false);
}

function draw_slider(no){
	ctx = document.getElementById("slider_" + (no + 1)).getContext("2d");
	x = slider_xs[no] + 48 + 0.5;

	ctx.clearRect(0, 0, 608, 128);
	ctx.beginPath();
	ctx.moveTo(64.5-16, 32.5);
	ctx.lineTo(0.5 + 16, 127.5 - 32);
	ctx.lineTo(607.5 - 16, 127.5 - 32);
	ctx.lineTo(607.5 - 64 + 16, 32.5);
	ctx.lineTo(64.5-16, 32.5);
	ctx.strokeStyle="#000000";
	ctx.stroke();
	ctx.closePath();
	ctx.fillStyle="#999999";
	ctx.fill();

	if(slider_set[no]){
		x_red = slider_user_xs[no] + 48 + 0.5;
		ctx.beginPath();
		ctx.moveTo(x_red, 0);
		ctx.lineTo(x_red - 64, 127);
		ctx.lineTo(x_red + 64, 127);
		ctx.lineTo(x_red, 0);
		ctx.strokeStyle="#660000";
		ctx.stroke();
		ctx.closePath();
		ctx.fillStyle="#ffcccc";
		ctx.fill();
	}

	ctx.beginPath();
	ctx.moveTo(x, 0);
	ctx.lineTo(x - 64, 127);
	ctx.lineTo(x + 64, 127);
	ctx.lineTo(x, 0);
	ctx.strokeStyle="#000000";
	ctx.stroke();
	ctx.closePath();
	ctx.fillStyle="#cccccc";
	ctx.fill();
}

function reveal(no){
	slider_set[no] = true;
	slider_user_xs[no] = slider_xs[no];
	slider_xs[no] = slider_true_xs[no];
	draw_slider(no);
	comment_on_slider(no);
	document.getElementById("the_truth_" + (no + 1)).style.display = "block";
	document.getElementById("button_" + (no + 1)).style.display = "none";

	for(var i = 0; i < 8; i++){
		if(slider_set[i] == false)
			return;
	}

	document.getElementById("show_in_the_end").style.display = "block";
	var score = 0;
	var default_score = 0;
	for(var i = 0; i < 8; i++){
		score += Math.abs(slider_user_xs[i] - slider_xs[i]);
		default_score += Math.abs(256 - slider_xs[i]);
	}

	document.getElementById("score").innerHTML = "<b>" + score.toFixed(0) + "</b>";
	document.getElementById("default_score").innerHTML = "<b>" + default_score.toFixed(0) + "</b>";
}

function colorized(text) {
	const separators = ['\n', ' ', '\t', '.', ',', ':', '=', '[', ']', '(', ')'];
	const comments = [['/*', '*/'], ['#', '\n']];

	function painted_in(line, color) {
		return line.length == 0 ? "" : "<span style=\"color:#" + color + "\">" + line + "</span>";
	}

	function colorized(token) {
		var code_sum = 0;
		for(var i = 0; i < token.length; ++i)
			code_sum += ([1, 7, 11, 13][i % 4] * token.charCodeAt(i));
		var zero_channel = code_sum % 3;
		var color = '' + (zero_channel == 0 ? '0' : '') + (1 + (code_sum % 5) * 2)
			+ (zero_channel == 1 ? '0' : '') + (4 + (code_sum % 2) * 5)
			+ (zero_channel == 2 ? '0' : '');
		return painted_in(token, color);
	}

	function separated(line, i) {
		if(i == separators.length)
			return colorized(line);
		return line.split(separators[i]).map(function(subline) {
			return separated(subline, i + 1);}).join(separators[i]);
	}

	function uncommented(line, i) {
		if(i == comments.length)
			return separated(line, 0);
		var chunks = line.split(comments[i][0]);
		return uncommented(chunks[0], i + 1) + chunks.slice(1).map( function(chunk) {
			var in_out_comment = chunk.split(comments[i][1]);
			return painted_in(comments[i][0] + in_out_comment[0] + (in_out_comment.length > 1 ? comments[i][1] : ''), "777")
				+ uncommented(in_out_comment.slice(1).join(comments[i][1]), i + 1);}).join('');
	}

	return uncommented(text, 0);
}
	</script>
</head>
<body>
	<center>
	<h1>
Challenge your performance intuition with C++ sine
	</h1>
	<p>
	</p>
	<table><tr>
	<td>
	<pre style="width: 505pt;">
#include &lt;chrono&gt;
#include &lt;iostream&gt;
#include &lt;random&gt;
#include &lt;array&gt;

int main() {
    constexpr auto n = 10000000;
    std::mt19937 rng(0);
    std::uniform_real_distribution&lt;double&gt; distribution(0, 2);
    std::vector&lt;double&gt; xs(n);
    for (auto &x : xs) {
        x = distribution(rng);
    }

    auto start = std::chrono::system_clock::now();

    auto side_effect = 0;
    for (auto i = 0u; i &lt; n; ++i)
        <b>... affect the side effect ...</b>

    auto end = std::chrono::system_clock::now();

    std::cout &lt;&lt; "time: " &lt;&lt; (end-start).count() * 1e-9 
              &lt;&lt; "  se: " &lt;&lt; side_effect &lt;&lt; "\n";
}
</pre>
	</td></tr></table>
	<p>

	</p>

	<h2>
Round 1. Sine vs. a small lookup table
	</h2>
	<p>
	</p>
	<table><tr>
	<td id="left_1">
	<pre>
double sum  = 0.;
for (auto i = 0u; i &lt; n; ++i)
    sum += std::sin(xs[i]);
	</pre>
	</td>
	<td id="right_1">
	<pre>
constexpr auto ln = 100;
std::array&lt;double, ln&gt; lookup;
for(auto i = 0u; i &lt; ln; ++i)
    lookup[i] = sin(static_cast&lt;double&gt;(i) 
        / static_cast&lt;double&gt;(ln));

<b>...</b>

double sum  = 0.;
for (auto i = 0u; i &lt; n; ++i)
    sum += lookup[static_cast&lt;size_t&gt;(xs[i] * ln)];
	</pre>
	</td></tr></table>
	<canvas id="slider_1" width=608 height=128></canvas>
	<p class="comment" id="comment_1">

	</p>
	<button type="button" onclick="reveal(0)" id="button_1">Reveal the truth</button>
	<div id="the_truth_1" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_1_1">
double sum  = 0.;
for (auto i = 0u; i &lt; n; ++i)
    sum += std::sin(xs[i]);
    </pre>
	</td>
	<td>
	<pre id="code_1_2">
constexpr auto ln = 10000000;
std::array&lt;double, ln&gt; lookup;
for(auto i = 0u; i &lt; ln; ++i)
    lookup[i] = sin(static_cast&lt;double&gt;(i) 
        / static_cast&lt;double&gt;(ln));

<b>...</b>

double sum  = 0.;
for (auto i = 0u; i &lt; n; ++i)
    sum += lookup[static_cast&lt;size_t&gt;(xs[i] * ln)];
    </pre>
	</td></tr></table>
	<p>

	</p>
	</div>
	<script language="JavaScript">
	init_slider(0);
	</script>

	<h2>
Round 2. Sine vs. a large lookup table
	</h2>
	<p>

	</p>
	<table><tr>
	<td id="left_2">
	<pre>

	</pre>
	</td>
	<td id="right_2">
	<pre>

	</pre>
	</td></tr></table>
	<canvas id="slider_2" width=608 height=128></canvas>
	<p class="comment" id="comment_2">

	</p>
	<button type="button" onclick="reveal(1)" id="button_2">Reveal the truth</button>
	<div id="the_truth_2" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_2_1">

    </pre>
	</td>
	<td>
	<pre id="code_2_2">

    </pre>
	</td></tr></table>
	<p>

	</p>
	</div>
	<script language="JavaScript">
	init_slider(1);
	</script>

	<h2>
Round 3. Double precision sine vs. single precision sine
	</h2>
	<p>

	</p>
	<table><tr>
	<td id="left_3">
	<pre>

	</pre>
	</td>
	<td id="right_3">
	<pre>

    </pre>
	</td></tr></table>
	<canvas id="slider_3" width=608 height=128></canvas>
	<p class="comment" id="comment_3">

	</p>
	<button type="button" onclick="reveal(2)" id="button_3">Reveal the truth</button>
	<div id="the_truth_3" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_3_1">

    </pre>
	</td>
	<td>
	<pre id="code_3_2">

    </pre>
	</td></tr></table>
	</div>
	<script language="JavaScript">
	init_slider(2);
	</script>

	<h2>
Round 4. sin() vs. std::sin()
	</h2>
	<p>

	</p>
	<table><tr>
	<td id="left_4">
	<pre>

    </pre>
	</td>
	<td id="right_4">
	<pre>

    </pre>
	</td></tr></table>
	<canvas id="slider_4" width=608 height=128></canvas>
	<p class="comment" id="comment_4">

	</p>
	<button type="button" onclick="reveal(3)" id="button_4">Reveal the truth</button>
	<div id="the_truth_4" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_4_1">

    </pre>
	</td>
	<td>
	<pre id="code_4_2">

    </pre>
	</td></tr></table>
	<p>

	</p>
	</div>
	<script language="JavaScript">
	init_slider(3);
	</script>

	<h2>
Round 5. Sine vs. a polynomial model
	</h2>
	<p>

	</p>
	<table><tr>
	<td id="left_5">
	<pre>

    </pre>
	</td>
	<td id="right_5">
	<pre>

    </pre>
	</td></tr></table>
	<canvas id="slider_5" width=608 height=128></canvas>
	<p class="comment" id="comment_5">

	</p>
	<button type="button" onclick="reveal(4)" id="button_5">Reveal the truth</button>
	<div id="the_truth_5" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_5_1">

    </pre>
	</td>
	<td>
	<pre id="code_5_2">

    </pre>
	</td></tr></table>
	</div>
	<script language="JavaScript">
	init_slider(4);
	</script>

	<h2>
Round 6. Multiplication vs. division in pure computation
	</h2>
	<p>

	</p>
	<table><tr>
	<td id="left_6">
	<pre>

	</pre>
	</td>
	<td id="right_6">
	<pre>

	</pre>
	</td></tr></table>
	<canvas id="slider_6" width=608 height=128></canvas>
	<p class="comment" id="comment_6">

	</p>
	<button type="button" onclick="reveal(5)" id="button_6">Reveal the truth</button>
	<div id="the_truth_6" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_6_1">

    </pre>
	</td>
	<td>
	<pre id="code_6_2">

    </pre>
	</td></tr></table>
	</div>
	<script language="JavaScript">
	init_slider(5);
	</script>

	<h2>
Round 7. Division vs. multiplication in array
	</h2>
	<p>

	</p>
	<table><tr>
	<td id="left_7">
	<pre>

    </pre>
	</td>
	<td id="right_7">
	<pre>

    </pre>
	</td></tr></table>
	<canvas id="slider_7" width=608 height=128></canvas>
	<p class="comment" id="comment_7">

	</p>
	<button type="button" onclick="reveal(6)" id="button_7">Reveal the truth</button>
	<div id="the_truth_7" style="display:none;">
	<p>

	</p>
	<table><tr>
	<td>
	<pre id="code_7_1">

    </pre>
	</td>
	<td>
	<pre id="code_7_2">

    </pre>
	</td></tr></table>
	<p>

	</p>
	</div>
	<script language="JavaScript">
	init_slider(6);
	</script>


	<div id="show_in_the_end" style="display:none;">
	<h2>
Congratulations!
	</h2>
	<p>
You scored <span id="score"></span> pixels of error. As a reference, if you leave every slider untouched there would be exactly <span id="default_score"></span> pixels of error.
	</p>

	<h2>
Conclusion
	</h2>
	<p>
	</p>
	</div>
	<script language="JavaScript">
	document.getElementById("code_1_1").innerHTML = colorized(document.getElementById("code_1_1").innerHTML);
	document.getElementById("code_1_2").innerHTML = colorized(document.getElementById("code_1_2").innerHTML);
	document.getElementById("code_2_1").innerHTML = colorized(document.getElementById("code_2_1").innerHTML);
	document.getElementById("code_2_2").innerHTML = colorized(document.getElementById("code_2_2").innerHTML);
	document.getElementById("code_3_1").innerHTML = colorized(document.getElementById("code_3_1").innerHTML);
	document.getElementById("code_3_2").innerHTML = colorized(document.getElementById("code_3_2").innerHTML);
	document.getElementById("code_4_1").innerHTML = colorized(document.getElementById("code_4_1").innerHTML);
	document.getElementById("code_4_2").innerHTML = colorized(document.getElementById("code_4_2").innerHTML);
	document.getElementById("code_5_1").innerHTML = colorized(document.getElementById("code_5_1").innerHTML);
	document.getElementById("code_5_2").innerHTML = colorized(document.getElementById("code_5_2").innerHTML);
	document.getElementById("code_6_1").innerHTML = colorized(document.getElementById("code_6_1").innerHTML);
	document.getElementById("code_6_2").innerHTML = colorized(document.getElementById("code_6_2").innerHTML);
	document.getElementById("code_7_1").innerHTML = colorized(document.getElementById("code_7_1").innerHTML);
	document.getElementById("code_7_2").innerHTML = colorized(document.getElementById("code_7_2").innerHTML);
	</script>

	<h2>
Links
	</h2>
	<p>
<a href="https://wordsandbuttons.online/challenge_your_performance_intuition_with_cpp_magic_squares.html">Challenge your performance intuition with C++ magic squares</a>
	</p>
	<p>
<a href="https://wordsandbuttons.online/challenge_your_performance_intuition_with_nanosecond_sorting.html">Challenge your performance intuition with nanosecond sorting</a>
	</p>
	<p>
Further reading: <a href="https://medium.com/@veedrac/learning-the-value-of-good-benchmarking-technique-with-c-magic-squares-b61b3386c97f">Learning the value of good benchmarking technique with C++ magic squares</a>.
	</p>
	<p>
Github with <a href="https://github.com/akalenuk/wordsandbuttons/tree/master/exp/cpp_sine">all the experiments</a>.
	</p>

	<table class="footer" style="width: 555pt; padding: 64pt 0pt 32pt 0pt; background-color: transparent; font-family: sans-serif; font-size: 16pt; font-style: normal;">
	<tr>
	<td class="footer" style="vertical-align: middle; text-align: left; width: 64px; padding: 0; margin: 0; border: 0;">
		<a href="index.html">Index</a>
		<a href="all_programming.html">#programming</a> <a href="all_quizzes.html">#quizzes</a>
	</td>
	<td class="footer" style="vertical-align: middle; text-align: left; width: 200pt; padding: 0; margin: 0; border: 0;">
		&nbsp;&larr; there's more.
	</td>
	<td class="footer" style="vertical-align: middle; text-align: right; width: 300pt; padding: 0; margin: 0; border: 0;">
		+
		<a href="https://github.com/akalenuk/wordsandbuttons">Github</a> &
		<a href="https://twitter.com/wordsandbuttons">Twitter</a> &
		<a href="https://wordsandbuttons.online/rss"><span style="letter-spacing: 1pt;">RSS</span></a>
	</td>
	</tr>
	</table>
	</center>
</body>
</html>
